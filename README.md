# SeqPredNN

Deep feed-forward neural network for predicting amino acid sequences from protein conformations.

## Table of Contents

1. ![Requirements](##Requirements)
2. ![Usage](##Usage)
      1. ![Installing dependencies](###Installing-dependencies)
      2. ![Installing dependencies](###Predicting-protein-sequences)


## Requirements

* Python 3.9
* Pytorch
* Numpy
* SciKit-Learn
* Matplotlib
* Scipy
* Biopython

## Usage

### Installing dependencies

We recommend using ![conda](https://docs.conda.io/projects/conda/en/stable/user-guide/install/index.html) to install the required python packages in a contained environment:

1. Import the SeqPredNN environment using the SeqPredNN_environment.yml file
        conda env create -n SeqPredNN -f SeqPRedNN_environment.yml
2. Activate the conda environment before using SeqPredNN
        conda activate SeqPredNN

### Predicting protein sequences:

![Prediction process flowchart](/prediction_diagram.png)

1.  Prepare input files
        - ![featurise.py](/SeqPredNN) requires:
        1. a directory containing the .pdb format files of your protein structures
        2. a comma-separated list of protein names, pdb filepaths in the abovementioned directory, and protein chain IDs for each protein chain e.g. the row for chain B of protein 1HST in the file /examples/example_pdb_directory/1hst.pdb.gz would read "1HST, 1hst.pdb.gz, B"
        - examples of a ![chain list](/examples/chain_list.csv) and ![PDB directory](/examples/example_pdb_directory) are given in ![/examples/](/example)

2.  Generate structural features for your protein structures using ![featurise.py](/SeqPredNN)

        featurise.py -gm -o example_features examples/chain_list.csv examples/example_pdb_directory

    
    - examples/chain_list.csv is text file specifying the protein chains that must be featurised. It contains 
    - The `-gm` argument indicates that the structure files are gzipped and should be uncompressed before they are parsed (`-g`), and that modified amino acids should be converted to the appropriate unmodified standard amino acid (`-m`)
    - For additional command line arguments run `featurise.py --help`

2. Predict amino acid sequences using `prediction.py`

       prediction.py -p feature_directory examples/chain_list.txt pretrained_model/pretrained_parameters.pth
 
    - prediction-only mode (-p) does not evaluate the model by comparing predictions with the original sequence 
 
### Training your own model:

![Train process flowchart](/train_diagram.png)

1. Download the PDB files of the structures in your training dataset - https://www.wwpdb.org/ftp/pdb-ftp-sites
2. Featurise your protein strucutures using `featurise.py`
    - see **Predicting protein sequences using the pretrained model** for more details
3. Train the model using `train_model.py`

       train_model.py -r 0.9 -t test_chains.txt -o my_model -e 200 feature_directory balanced

    - The train ratio (-r) is the fraction of residues assigned to the training dataset. The remaining residues are assigned to a validation set used to evaluate the model during training
    - The test chain file (-t) specifies which chains should be excluded from the training and validation datasets so that they can be used for independent evaluation of the model. The test chain file must be in the same format as examples/chain_list.txt.
    - (-e) is used to specify the number of epochs for training
    - The balanced/unbalanced keyword specifies the sampling mode. "unbalanced" sampling partitions all the residues in the features into the training and validation datasets. "balanced" sampling undersamples the residues so that each of the 20 amino acid classes occur the same number of times in the dataset.
4. Test your model using `prediction.py`
                
       prediction.py - o predictions feature_directory test_chains.txt my_model/model_parameters.pth
          
   * Evaluation output:
     * A classification report with precision, recall and f1-score for each amino acid class
     * The top K accuracy of the predictions for each amino acid class
     * 3 confusion matrices (unnormalised, normalised by prediciton and normalised by true residue)
     * For each chain in the test set:
       * The predicted sequence
       * The probabilities for each amino acid class produced by the model for each preducted residue
       * A classification report
       * Cross-entropy loss for each predicted residue

## Pretrained model 

The pretrained model was trained using the chains in pretrained_model/40_res3_nobrks.pisces. The dataset consists of 18914 chains with less than 40% sequence similarity, resolution < 3 angstrom, no chain breaks, length of 40-10000 residues, R-factor < 0.3 and only X-ray crystallography structures. It was generated by the [pisces server](https://dunbrack.fccc.edu/pisces/) on 2021-11-19. Some proteins in 40_res3_nobrks.pisces were missing from the PDB snapshot used to train the model - these chains were excluded from the training data and are listed in pretrained_model/excluded.txt. We excluded a random test set (pretrained_model/random_test_set.txt) of 10% of the chains from training. 

## Licence
This software and code is distributed under a GNU General Public License V3

## Poster

![SeqPredNN Conference Poster](/SeqPredNN_Poster.png)
